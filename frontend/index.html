<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo Microservicios - Habitaciones</title>
  <style>
    :root{
      --bg:#f6f8fa;
      --card:#ffffff;
      --accent:#0b5ed7;
      --muted:#6b7280;
      --success:#198754;
      --danger:#dc3545;
      --radius:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:#111;}
    header{background:linear-gradient(90deg,#0b63d7 0%, #0b5ed7 100%);padding:18px;color:white}
    .container{max-width:1100px;margin:20px auto;padding:0 16px;}
    h1{margin:0;font-size:1.4rem}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:transparent;color:white;border:1px solid rgba(255,255,255,0.18)}
    .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:18px}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .card h3{margin:0 0 6px 0;font-size:1.05rem}
    .card p{margin:0;color:var(--muted);font-size:0.95rem}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .price{font-weight:700;color:var(--success)}
    .filters{display:flex;gap:8px;align-items:center;margin-left:8px}
    .input, select{padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:white}
    .center{display:flex;align-items:center;gap:10px}
    .table{width:100%;border-collapse:collapse;margin-top:18px;background:var(--card);border-radius:8px;overflow:hidden}
    .table th, .table td{padding:10px;text-align:left;border-bottom:1px solid #eef2f6}
    .table th{background:#f3f6fb}
    .small{font-size:0.9rem;color:var(--muted)}
    .loading{display:flex;align-items:center;gap:8px}
    .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .notice{padding:10px;border-radius:8px;background:#fff3cd;color:#856404;margin-top:10px}
    @media(max-width:520px){
      .topbar{flex-direction:column;align-items:stretch;gap:8px}
      .controls{justify-content:space-between}
    }
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <div>
        <h1>Plataforma de Habitaciones — Demo</h1>
        <div class="small">Microservicios local · SonarCloud / CodeQL integrados</div>
      </div>
      <div class="controls">
        <div id="authArea" class="center">
          <input id="user" class="input" placeholder="usuario" value="test" aria-label="usuario" />
          <input id="pass" class="input" placeholder="contraseña" value="test" type="password" aria-label="contraseña" />
          <button id="btnLogin">Iniciar sesión</button>
        </div>
        <button id="btnRefresh" title="Recargar habitaciones">Recargar</button>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <div class="center" style="justify-content:space-between">
      <div class="center">
        <label class="small" for="filter">Buscar:</label>
        <input id="filter" class="input" placeholder="Filtrar por nombre..." />
        <div class="filters">
          <label class="small">Ordenar:</label>
          <select id="sort" class="input" aria-label="ordenar">
            <option value="name-asc">Nombre ↑</option>
            <option value="name-desc">Nombre ↓</option>
            <option value="price-asc">Precio ↑</option>
            <option value="price-desc">Precio ↓</option>
          </select>
        </div>
        <div class="filters">
          <label class="small">Max precio:</label>
          <input id="maxPrice" class="input" placeholder="ej. 300000" type="number" />
        </div>
      </div>

      <div id="status" class="small center"></div>
    </div>

    <div id="results" aria-live="polite">
      <!-- Aquí se inyecta la UI -->
      <div id="cards" class="card-grid" style="margin-top:12px"></div>

      <table id="table" class="table" style="display:none;margin-top:14px">
        <thead><tr><th>Habitación</th><th>Id</th><th>Precio</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div id="noticeArea" style="margin-top:10px"></div>
    </div>
  </main>

<script>
(() => {
  // Configura las rutas locales a tus microservicios
  const ROOMS_URL = 'http://localhost:5001/rooms';
  const LOGIN_URL = 'http://localhost:5000/login';

  // Estado
  let rooms = [];
  let token = null;

  // Elementos
  const btnRefresh = document.getElementById('btnRefresh');
  const btnLogin = document.getElementById('btnLogin');
  const userInput = document.getElementById('user');
  const passInput = document.getElementById('pass');
  const cardsEl = document.getElementById('cards');
  const tableEl = document.getElementById('table');
  const tableBody = document.getElementById('tableBody');
  const statusEl = document.getElementById('status');
  const filterEl = document.getElementById('filter');
  const sortEl = document.getElementById('sort');
  const maxPriceEl = document.getElementById('maxPrice');
  const noticeArea = document.getElementById('noticeArea');

  function setStatus(text, loading=false, danger=false){
    statusEl.innerHTML = '';
    if(loading){
      const s=document.createElement('div'); s.className='loading';
      s.innerHTML = '<div class="spinner" role="status" aria-hidden="true"></div><div>'+text+'</div>';
      statusEl.appendChild(s);
    } else {
      const span = document.createElement('div');
      span.textContent = text;
      if(danger) span.style.color='var(--danger)';
      statusEl.appendChild(span);
    }
  }

  function showNotice(msg, type='info'){
    noticeArea.innerHTML = '<div class="notice">'+msg+'</div>';
  }

  function clearNotice(){ noticeArea.innerHTML = ''; }

  function formatCurrency(n){
    return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits:0 }).format(n);
  }

  function renderCards(list){
    cardsEl.innerHTML = '';
    if(list.length === 0){
      cardsEl.innerHTML = '<div class="small">No se encontraron habitaciones.</div>';
      return;
    }
    list.forEach(r => {
      const c = document.createElement('div');
      c.className='card';
      c.innerHTML = `<h3>${escapeHtml(r.Name)}</h3>
                     <p class="small">ID: ${r.Id}</p>
                     <div class="meta">
                       <div class="small">${escapeHtml(r.Name)} - descripción demo</div>
                       <div class="price">${formatCurrency(r.Price)}</div>
                     </div>`;
      cardsEl.appendChild(c);
    });
  }

  function renderTable(list){
    tableBody.innerHTML = '';
    list.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(r.Name)}</td><td>${r.Id}</td><td>${formatCurrency(r.Price)}</td>`;
      tableBody.appendChild(tr);
    });
    tableEl.style.display = list.length ? 'table' : 'none';
  }

  function applyFiltersAndRender(){
    let list = [...rooms];

    // filter by text
    const q = filterEl.value.trim().toLowerCase();
    if(q) list = list.filter(r => r.Name.toLowerCase().includes(q));

    // max price
    const mp = parseFloat(maxPriceEl.value);
    if(!isNaN(mp)) list = list.filter(r => r.Price <= mp);

    // sort
    const s = sortEl.value;
    if(s === 'name-asc') list.sort((a,b)=>a.Name.localeCompare(b.Name));
    if(s === 'name-desc') list.sort((a,b)=>b.Name.localeCompare(a.Name));
    if(s === 'price-asc') list.sort((a,b)=>a.Price - b.Price);
    if(s === 'price-desc') list.sort((a,b)=>b.Price - a.Price);

    renderCards(list);
    renderTable(list);
  }

  async function fetchRooms(){
    clearNotice();
    setStatus('Cargando habitaciones...', true);
    try {
      const headers = {};
      if(token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(ROOMS_URL, { headers, cache: "no-store" });
      if(!res.ok) {
        if(res.status === 401) {
          throw new Error('No autorizado. Inicia sesión.');
        }
        throw new Error('Error al obtener habitaciones: ' + res.status + ' ' + res.statusText);
      }
      const data = await res.json();
      if(!Array.isArray(data)) {
        throw new Error('Respuesta inesperada del servidor');
      }
      // Normalizar campos (soporte a diferentes formatos)
      rooms = data.map(x => ({
        Id: x.Id ?? x.id ?? x.idRoom ?? 0,
        Name: x.Name ?? x.name ?? x.roomName ?? 'Habitación',
        Price: Number(x.Price ?? x.price ?? x.amount ?? 0)
      }));
      setStatus('Habitaciones cargadas: ' + rooms.length);
      applyFiltersAndRender();
    } catch (err) {
      setStatus('Error: ' + err.message, false, true);
      showNotice('No se pudieron cargar las habitaciones. ' + err.message);
      cardsEl.innerHTML = '';
      tableBody.innerHTML = '';
      tableEl.style.display = 'none';
    }
  }

  async function doLogin(){
    clearNotice();
    setStatus('Iniciando sesión...', true);
    try {
      const body = { user: userInput.value, password: passInput.value };
      const res = await fetch(LOGIN_URL, {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body),
        cache: "no-store"
      });
      if(!res.ok) throw new Error('Credenciales incorrectas ('+res.status+')');
      const j = await res.json();
      token = j.token || j.accessToken || null;
      if(token){
        setStatus('Usuario autenticado ✓');
        showNotice('Autenticación OK. Ahora las llamadas enviarán token al servicio.');
      } else {
        setStatus('Login OK (sin token devuelto).', false);
      }
      // recargar datos ya autenticados
      await fetchRooms();
    } catch(err){
      setStatus('Error login: ' + err.message, false, true);
      showNotice('Error al iniciar sesión: ' + err.message);
    }
  }

  // escape simple para inyección en HTML
  function escapeHtml(s){
    if(!s) return '';
    return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  // eventos
  btnRefresh.addEventListener('click', fetchRooms);
  btnLogin.addEventListener('click', doLogin);
  filterEl.addEventListener('input', applyFiltersAndRender);
  sortEl.addEventListener('change', applyFiltersAndRender);
  maxPriceEl.addEventListener('input', applyFiltersAndRender);

  // carga inicial
  fetchRooms();

})();
</script>
</body>
</html>
